\documentclass[12pt]{article}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{graphicx}
\usepackage[hidelinks]{hyperref}
\usepackage{float}
\usepackage{tcolorbox}
\usepackage[margin=1.25in]{geometry}

\newcommand{\executable}[1]{{\fontfamily{pcr}\selectfont\textbf{#1}}}
\newcommand{\parameters}[1]{{\fontfamily{pcr}\selectfont#1}}

\newcommand{\hrefc}[2]{\href{#1}{\color{blue}#2}}

% \setlength{\textwidth}{6.25in}
\setlength\parindent{0pt}

% \graphicspath{ {./images/} }

\makeindex

\title{ClC\_MKM v0.1 Manual}
\author{Austen Bernardi}
\date{\today}

\begin{document}
\maketitle{}

\tableofcontents
\clearpage
\newpage

\section{Introduction}

ClC\_MKM contains Python libraries and executables for steady-state kinetic modeling and optimization a ClC-ec1 Markov State Model. ClC-ec1 is a secondary-active Chloride/Proton transmembrane antiporter \cite{mayes2018multiscale}. ClC\_MKM supports optimization of kinetic rate coefficients between biologically relevant transitions against experimentally derived unitary turnover rates \cite{lim2009intracellular}. ClC\_MKM has built-in support for optimization using SpotPy \cite{houska2015spotting} or SciPy \cite{virtanen2020scipy}. This manual describes how to use ClC\_MKM to perform optimization.

\section{License}
ClC\_MKM uses the GNU General Public License v3.  See \parameters{ClC\_MKM/LICENSE} for more information.

\section{Requirements}
ClC\_MKM requires the following:

\begin{itemize}
\item Python 3
\item SciPy \cite{virtanen2020scipy}
\item SpotPy \cite{houska2015spotting}
\item NumPy
\item CycFlowDec \cite{bernardi2021cycflowdec} (\hrefc{https://github.com/austenb28/CycFlowDec}{https://github.com/austenb28/CycFlowDec})
\item MatPlotLib
\end{itemize}

\section{Installation}
Download the top directory \parameters{ClC\_MKM} to a directory that will store the module. Update your \parameters{\$PYTHONPATH} environment variable to include the storage directory if it is not already included. Update your \parameters{\$PATH} environment variable to include \parameters{ClC\_MKM/bin}. For example, on a Unix based system using a bash shell, if the storage directory is \parameters{\$HOME/modules}, then adding \\


\parameters{export PYTHONPATH=\$PYTHONPATH:"\$HOME/modules"}

\parameters{export PATH=\$PATH:"\$HOME/modules/ClC\_MKM/bin"}\\

to \parameters{\$HOME/.bashrc} properly installs ClC\_MKM.

\subsection{Troubleshooting}
\begin{itemize}
\item \textbf{Installing on recently updated macOS?} You're probably running Zsh instead of bash, so you'll need to modify \parameters{\$HOME/.zshrc} instead of \parameters{\$HOME/.bashrc} with the export lines above.
\item \textbf{Getting a \parameters{"No module named 'ClC\_MKM'"} error?} Your installation folder must be named \parameters{"ClC\_MKM"}.  If you downloaded as zip from GitHub, you probably need to rename from \parameters{"ClC\_MKM-main"}.
\end{itemize}

\section{Executables}
\label{sec:exec}

This section describes the executables provided in \parameters{ClC\_MKM/bin}.

\subsection{\executable{run\_opt.py}}
\executable{run\_opt.py }\parameters{<config>}\\[0.2cm]
\textbf{Description}\\
Performs optimization on the ClC-ec1 system specified by \parameters{<config>}.  Optimized coefficients are written to \parameters{"out\_coeffs.csv"}. See section \ref{sec:examp} for a usage examples.\\[0.2cm]
\textbf{Parameters}\\
\parameters{<config>}: A configuration file containing parameters for the ClC-ec1 system.  Also specifies the optimization configuration file.  The format of this configuration file is specified in section \ref{sec:sys_config}.

\subsection{\executable{run\_rpa.py}}
\executable{run\_rpa.py }\parameters{<config>}\\[0.2cm]
\textbf{Description}\\
Performs reaction path analysis using cyclic flow decomposition \cite{bernardi2021cycflowdec} on the first ClC-ec1 system specified by \parameters{<config>}. See section \ref{sec:examp} for a usage examples.\\[0.2cm]
\textbf{Parameters}\\
\parameters{<config>}: A configuration file containing parameters for the ClC-ec1 system. The format of this configuration file is specified in section \ref{sec:sys_config}. Only performs RPA on the first system.

\subsection{\executable{parse\_cycles.py}}
\executable{parse\_cycles.py }\parameters{-bn <basename> -ci <init\_coeffs> -d <dir> {-}{-}opp}\\[0.2cm]
\textbf{Description}\\
Parses cycles generated by \parameters{run\_rpa.py}, generating various output files describing the flow cycles. See section \ref{sec:examp} for a usage examples.\\[0.2cm]
\textbf{Parameters}\\
\parameters{-bn <basename>}: Basename for output filenames (default \parameters{"biological"} or \parameters{"opposite"} depending on \parameters{--opp}). \\[0.2cm]
\parameters{-ci <init\_coeffs>}: Name of initial coeffs file (.csv). \\[0.2cm]
\parameters{-d <dir>}: Directory containing \parameters{cycle\_dat.pickle} (default \parameters{"./"}). \\[0.2cm]
\parameters{{-}{-}opp}: Use to flip stoichiometry for opposite orientation.

\subsection{\executable{opt\_flows.py}}
\executable{opt\_flows.py }\parameters{<config> -f <opt\_dat>}\\[0.2cm]
\textbf{Description}\\
Writes stepwise flow values to \parameters{"ion\_flows\_sys<j>.dat"}, where \parameters{<j>} corresponds to the index of the system specified in the configuration file.\\[0.2cm]
\textbf{Parameters}\\
\parameters{<config>}: A configuration file containing parameters for the ClC-ec1 systems.  The format of this configuration file is specified in section \ref{sec:config}.  Should directly correspond to the \parameters{<config>} used to generate \parameters{opt\_dat}. \\[0.2cm]
\parameters{<opt\_dat> (optional)}: Filename of output optimization coefficients. Default is \parameters{"opt.dat"}.

\subsection{\executable{run\_mkm.py}}
\executable{run\_mkm.py }\parameters{<config>}\\[0.2cm]
\textbf{Description}\\
Generates instances of the ClC-ec1 systems specified by \parameters{<config>}. See section \ref{sec:examp} for a usage example.\\[0.2cm]
\textbf{Parameters}\\
\parameters{<config>}: A configuration file containing parameters for the ClC-ec1 system.  The format of this configuration file is specified in section \ref{sec:config}.

\section{Configuration files}
\label{sec:config}
This section describes the various configuration files used by ClC\_MKM.  Representative example configuration files are provided in the \parameters{ClC\_MKM/examples} directory, and discussed in section \ref{sec:examp}.  Lines may be commented using the '\#' symbol. The parameter specification format for all configuration files is \parameters{param = <param\_list>}, where \parameters{<param\_list>} is a comma-seperated (without spaces) list of values, ex. \parameters{<val1,val2,val3,...>}.  Space seperated text after \parameters{<param\_list>} is ignored and can be used as comments (ex. units).  If any \parameters{<param\_list>} has length greater than one, all other \parameters{<param\_list>} must have the same length or length one.  If a \parameters{<param\_list>} is length one and another \parameters{<param\_list>} has length greater than one, then the value is used for all systems. In some cases, \parameters{<param\_list>} must be length one, indicated by \parameters{scalar}. A listed \parameters{param} is considered to be required unless specified as \parameters{optional}.  

\subsection{Systems configuration file}
\label{sec:sys_config}
This is the main configuration file that is used as the argument for both executables listed in section \ref{sec:exec}.  See below for the full list of accepted parameters.\\

\executable{input\_rate\_file} \parameters{(scalar)}

The input rate coefficient filename for the kinetic model. File should be comma-seperated.  Line 1: parameter identifiers. Line 2: parameter values. Line 3: lower bounds for optimization. Line 4: upper bounds for optimization.  If lines 3 and 4 are not present, lower and upper bounds are uniformly set to zero and infinity, respectively.  See \parameters{ClC\_MKM/examples/opt/custom/seed\_dru\_san.csv} for an example with bounds specified. Units are 1/ms.\\

\executable{rate\_map\_file} \parameters{(scalar)}

The rate coefficient map filename for the kinetic model.  Used to map coefficients to applicable transitions.  See examples for formatting.\\

\executable{internal\_pH}

The pH(s) inside the vesicles of the modeled systems.\\

\executable{external\_pH}

The pH(s) outside the vesicles of the modeled systems.\\

\executable{internal\_Cl\_conc}

The chloride concentration(s) in mol/m$^3$ inside the vesicles.\\

\executable{external\_Cl\_conc}

The chloride concentration(s) in mol/m$^3$ outside the vesicles.\\

\executable{enzyme\_MW}

The molecular weight of the antiporter in g/mol.\\

\executable{lipid\_MW}

The molecular weight of the lipids that make up the vesicles in g/mol.\\

\executable{area\_per\_lipid}

The average surface area per lipid in m$^2$ of the lipids that make up the vesicles.\\

\executable{enzyme\_lipid\_wtfrac}

The weight fraction of enymes to lipids of the vesicles.\\

\executable{h\_rxn\_bl}

The approximate height of the reactive boundary layer for vesicle surface uptake reactions.\\

\executable{diffusivity\_Cl}

The bulk diffusivity of Chlorides.\\

\executable{diffusivity\_H}

The bulk diffusivity in m$^2$/ms of protons.\\

\executable{vesicle\_diam}

The average diameter in m of the vesicles.\\

\executable{enzyme\_surf\_conc\_sim}

The surface concentration of enzymes in mol/m$^2$ for the simulations used to model the uptake coefficients.\\

\executable{opt\_config\_file} \parameters{(scalar)}

Required only for \executable{run\_opt.py}. The filename of the optimization configuration file. See section \ref{sec:opt_config} for details.\\

\subsection{Optimization configuration file}
\label{sec:opt_config}
This configuration file is specified by the main configuration file as \parameters{opt\_config\_file}. For use with \executable{run\_opt.py}.  See below for the full list of accepted parameters.\\

\executable{opt\_package} \parameters{(optional, scalar)}

The name of the optimization package to use.  A custom combined steepest descent/conjugate gradient method is used if unspecified.  Supported packages are "scipy" and "spotpy". See section \ref{sec:examp} for example use cases.\\

\executable{opt\_residuals\_file} \parameters{(scalar)}

The optimization residuals filename.  This file contains residual targets for specified flows, and is used to build the objective function using a sum of square residual differences. See section \ref{sec:res_config} for details.\\

\executable{opt\_dat\_file} \parameters{(optional,scalar)}

Filename for the output optimization data (step, parameters, objective). Default value is \parameters{"opt.dat"}.\\

\executable{n\_steps} \parameters{(scalar)}

The number of steps for optimization (outermost level).\\

\executable{output\_interval} \parameters{(scalar)}

The interval between consecutive output records. A value of 1 records every step, a value of 2 records every other step, etc.\\

\executable{local\_method} \parameters{(scalar)}

Only used when \parameters{opt\_package} is "scipy". The local optimization method. Accepted values are listed under the "method" parameter of the \hrefc{https://docs.scipy.org/doc/scipy/reference/reference/generated/scipy.optimize.minimize.html}{\parameters{scipy.optimize.minimize}} documentation.\\

\executable{local\_options\_file} \parameters{(optional, scalar)}

Only used when \parameters{opt\_package} is "scipy". The local optimization options configuration filename. Format is consistent with the generic configuration file format specified in section \ref{sec:config}.  Only supports scalar parameters. Accepted values are consistent with the arguments listed under the specific SciPy \hrefc{https://docs.scipy.org/doc/scipy/reference/reference/optimize.html\#local-multivariate-optimization}{local method}  documentation. See section \ref{sec:examp} for an example use case.\\

\executable{global\_method} \parameters{(optional,scalar)}

Only used when \parameters{opt\_package} is "scipy". The global optimization method. Accepted values are listed under the \hrefc{https://docs.scipy.org/doc/scipy/reference/reference/optimize.html\#global-optimization}{Global Optimization} section of SciPy's optimize documentation. Method "brute" is not supported.\\

\executable{global\_options\_file} \parameters{(optional, scalar)}

Only used when \parameters{opt\_package} is "scipy". The global optimization options configuration filename. Format is consistent with the generic configuration file format specified in section \ref{sec:config}.  Only supports scalar parameters. Accepted values are consistent with the arguments listed under the specific SciPy \hrefc{https://docs.scipy.org/doc/scipy/reference/reference/optimize.html\#global-optimization}{global method}  documentation. See section \ref{sec:examp} for an example use case.\\

\executable{algorithm} \parameters{(scalar)}

Only used when \parameters{opt\_package} is "spotpy".  Specifies the algorithm used for SpotPy optimization.  See SpotPy's \hrefc{https://spotpy.readthedocs.io/en/latest/Algorithm_guide/}{Algorithm Guide} for a list of accepted values (lowercase abbreviations).\\

\executable{limp} \parameters{(scalar)}

Only used when \parameters{opt\_package} is not specified.  Specifies the target lower bound for improvement in the objective for a single step.\\

\executable{uimp} \parameters{(scalar)}

Only used when \parameters{opt\_package} is not specified.  Specifies the target upper bound for improvement in the objective for a single step.\\

\executable{max\_limp\_steps} \parameters{(scalar)}

Only used when \parameters{opt\_package} is not specified.  Specifies the maximum number of steps in which the improvement is below \parameters{limp} before switching from steepest descent to conjugate gradient.\\

\subsection{Residual configuration file}
\label{sec:res_config}

The residual configuration file details ion flow targets for optimization, which are combined using sum of squared residual differences.  Accepted parameters are listed below.  Note the length of \parameters{<param\_list>} must be consistent with the number of systems specified in the main configuration file, following the \parameters{<param\_list>} rules specified in section \ref{sec:config}. If a value is specified as \parameters{NaN}, then the corrosponding residual flow is ommitted from the objective function calculation.\\

\executable{net\_Cl\_flow} \parameters{(optional)}

The net chloride flow(s) directed from external to internal in ions/ms per enzyme.\\

\executable{net\_H\_flow} \parameters{(optional)}

The net proton flow(s) directed from external to internal in ions/ms per enzyme.\\

\executable{bio\_Cl\_flow} \parameters{(optional)}

The chloride flow(s) directed from external to internal in ions/ms per enzyme for biologically oriented enzymes.\\

\executable{bio\_H\_flow} \parameters{(optional)}

The proton flow(s) directed from external to internal in ions/ms per enzyme for biologically oriented enzymes.\\

\executable{opp\_Cl\_flow} \parameters{(optional)}

The chloride flow(s) directed from external to internal in ions/ms per enzyme for oppositely oriented enzymes.\\

\executable{opp\_H\_flow} \parameters{(optional)}

The proton flow(s) directed from external to internal in ions/ms per enzyme for oppositely oriented enzymes.\\

\executable{no\_flow\_sys} \parameters{(optional)}

Special boolean residual parameter (\parameters{"True"} or \parameters{"False"}). Designates a system to have no flow anywhere (microscopic reversibility), generally for use with zero gradient boundary conditions. See \parameters{ClC\_MKM/examples/opt/custom/opt\_residuals.txt} for a usage example.\\

\section{Examples}
\label{sec:examp}
See \parameters{ClC\_MKM/examples} for some usage examples.  \parameters{ClC\_MKM/examples/mkm} provides a single instance of the ClC-ec1 kinetic system to be executed with \parameters{"run\_mkm.py config.txt"}. All other examples are designed to be executed within their respective directories with \parameters{"run\_opt.py config.txt"}.  See below for commands that exhibit a traditional optimization/analysis workflow.

\begin{tcolorbox}
\executable{cd} \parameters{ ClC\_MKM/examples/opt/custom}\\
\executable{run\_opt.py}\parameters{ config.txt}\\
\executable{run\_rpa.py}\parameters{ config\_rpa.txt}\\
\executable{cd} \parameters{ biological}\\
\executable{parse\_cycles.py}\parameters{ -ci ../seed\_dru\_san.csv}\\
\executable{cd} \parameters{ ../opposite}\\
\executable{parse\_cycles.py}\parameters{ -ci ../seed\_dru\_san.csv {-}{-}opp}
\end{tcolorbox}

Executing the above commands should generate analysis files in subdirectories of the custom optimization.  The same workflow should work for the other optimization examples provided.  Note these examples are designed to execute quickly, and would require significantly more iterations to achieve complete optimization.

\section{References}
\begingroup
\renewcommand{\section}[2]{}
\bibliographystyle{plain}
\bibliography{Manual.bib}
\endgroup
\end{document}